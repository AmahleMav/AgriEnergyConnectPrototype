@model IEnumerable<AgriEnergyConnectPrototype.Models.Product>
@using AgriEnergyConnectPrototype.Models
@{
    ViewData["Title"] = "All Products";
    var locationQuery = Context.Request.Query["location"].ToString();
    var categoryQuery = Context.Request.Query["category"].ToString();
}

<div class="container my-5">
    <h2 class="fw-bold text-success mb-4">All Products</h2>

    <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" name="location" value="@locationQuery" placeholder="Filter by location" class="form-control" />
        </div>
        <div class="col-md-4">
            <input type="text" name="category" value="@categoryQuery" placeholder="Filter by category" class="form-control" />
        </div>
        <div class="col-md-4 d-flex">
            <button type="submit" class="btn btn-primary me-2">Search</button>
            <a href="@Url.Action("Index", "Products")" class="btn btn-outline-secondary">Clear</a>
        </div>
    </form>

    <div class="row g-4">
        @foreach (var p in Model)
        {
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="card h-100 shadow-sm border-0">

                    <!-- PRODUCT IMAGE (updated with product-img class) -->
                    <img class="card-img-top product-img"
                         src="@(string.IsNullOrWhiteSpace(p.ImageUrl) ? "/images/product.png" : p.ImageUrl)"
                         alt="@p.ProductName"
                         loading="lazy" />

                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h5 class="card-title fw-bold mb-0">@p.ProductName</h5>
                            @if (p.Kind == ProductKind.EnergySolution)
                            {
                                <span class="badge bg-info">Energy</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Produce</span>
                            }
                        </div>

                        <div class="text-muted small mb-2">@p.Category • @p.Location</div>

                        @if (p.Kind == ProductKind.Produce)
                        {
                            if (p.PricePerUnit.HasValue && !string.IsNullOrWhiteSpace(p.Unit))
                            {
                                <div class="fw-semibold mb-2">R @p.PricePerUnit.Value.ToString("0.##") / @p.Unit</div>
                            }
                            <div class="small">
                                <strong>Date:</strong> @(p.ProductionDate?.ToShortDateString() ?? "n/a")
                                @if (p.IsOrganic)
                                {
                                    <span class="badge bg-success ms-2">Organic</span>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="small mb-1"><strong>Vendor:</strong> @p.VendorName</div>
                            <div class="small mb-1">
                                <strong>Type:</strong> @p.EnergyType
                                @(p.PowerkW.HasValue ? $"• {p.PowerkW.Value:0.#} kW" : "")
                            </div>
                            @if (p.PriceZar.HasValue)
                            {
                                <div class="fw-semibold">From R @p.PriceZar.Value.ToString("N0")</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(p.SuitableFor))
                            {
                                <div class="small text-muted">For: @p.SuitableFor</div>
                            }
                        }

                        <div class="small mt-2">
                            <strong>Farmer:</strong> @p.FarmerProfile?.FirstName @p.FarmerProfile?.LastName
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
